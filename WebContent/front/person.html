
<link rel="stylesheet" href="../css/PersonPage.css">


<div class="left-nav">
	<div class="usrimg">
		<a><img id="nav_img" src="../images/null.jpg" /></a>
	</div>
	<div>
		<dl>
			<dt id="usrName"></dt>
			<dd>
				<a href="#" onclick="person()">个人资料</a>
			</dd>
			<dd>
				<a href="#" onclick="address()">收获地址</a>
			</dd>
		</dl>
	</div>

</div>
<div id="person" class="right-person">
	<form>
		<div class="main-person">
			<p>
				<label>当前头像：</label> <a href="#" onclick="changeImg()"> <img id="p_img" src="../images/null.jpg" />
				</a>
				<input id="imgFile" name="pics" type="file" multiple="multiple" style="display: none;" />
			</p>
			<p>
				<label> <em>*</em> 昵称
				</label> <input id="p_usrName" class="p-txt" type="text" value=""
					maxlength="25" onchange="checkName()" /> <br /> <span
					class="nullNameEr">昵称不能为空！</span> <span class="nameEr">该昵称已被使用，请重新输入！</span>
			</p>

			<p>
				<label> <em>*</em> 邮箱
				</label> <input id="p_email" class="p-txt" type="text" value=""
					maxlength="25" onchange="checkEmail()" /> <br /> <span
					class="emailEr">邮箱格式错误，请重新输入！</span> <span class="emailREEr">该邮箱已被使用，请重新输入！</span>
			</p>
			<p>
				<label> <em>*</em> 电话号码
				</label> <input id="p_phone" class="p-txt" type="text" value=""
					maxlength="25" onchange="checkPhone()" /> <br /> <span
					class="phoneEr">号码格式错误，请重新输入！</span> <span class="phoneReEr">该号码已被使用，请重新输入！</span>
			</p>

		</div>
		<div class="p-btn" style="width: 700px;">
			<input class="p-subm" type="button" value="保存" onclick="sumbit()" />
		</div>
	</form>
</div>
<div id="address" class="right-address">
	<div class="a-head"
		style="width: 100%; height: 30px; background-color: #f3f8fe;">
		<span style="line-height: 27px; margin-left: 5px; font-size: 15px;">收货地址</span>
	</div>
	<form>
		<div class="main-person">
			<p>
				<label style="float: left;"> <em>*</em> 地址信息
				</label> <span id="demo3" class="citys"> <select id="sl_province" name="province"></select>
					<select id="sl_city" name="city"></select> <select id="sl_area" name="area"></select>
					 <!--<select id="sl_town" name="town"></select>-->
				</span> <span id="place" class="hint" style="margin-left: 10px;">请选择地区</span>
			</p>
			<p>
				<label style="float: left;"> <em>*</em> 详细地址
				</label>
				<textarea id="area-textare" class="area-textare" rows="2" cols="20"
					placeholder="请输入详细地址,如道路, 门牌号, 小区, 楼栋号, 单元等信息" onblur="checkArea()"></textarea>
				<span class="areaEr" style="margin-left: 10px;">详细地址不能为空</span>
			</p>
			<p>
				<label style="margin-left: 7.28334px;"> 邮政编号 </label> <input
					id="p_num" class="p-txt" type="text" value="" maxlength="25"
					placeholder="请填写邮编" onblur="checkNum()" /> <span class="numEr"
					style="color: red; display: none">邮编填写错误</span>
			</p>
			<p>
				<label> <em>*</em> 收货人姓名
				</label> <input id="consigneeName" class="p-txt" type="text" value=""
					maxlength="25" placeholder="长度不超过25个字符" onblur="checkCName()" /> <span
					class="lengthEr">姓名不能为空</span>
			</p>
			<p>
				<label> <em>*</em> 电话号码
				</label> <input id="adPhone" class="p-txt" type="text" value=""
					maxlength="25" onblur="checkAdPhone()" /> <span class="adPhoneEr">电话号码不能为空或格式错误</span>
			</p>
			<p>
				<input id="isDefault" class="" type="checkbox" aria-checked="false" />是否设置为默认地址
			</p>
		</div>
		<div class="p-btn" style="width: 700px;">
			<input id="adBtn" class="p-subm" type="button" value="保存" onclick="sumbitAdr()" />
		</div>
	</form>

	<div class="next_table">
		<table role="table" style="box-sizing: border-box;">
			<colgroup>
				<col style="width: 90px;" />
				<col "/>
				<col style="width: 190px;" />
				<col style="width: 100px;" />
				<col style="width: 140px;" />
				<col style="width: 80px;" />
				<col style="width: 100px;" />
			</colgroup>
			<thead class="next_table_header">
				<tr>
					<th rowspan="1" type="header" role="gridcell">
						<div class="next_table_cell_wrapper">收货人</div>
					</th>
					<th rowspan="1" type="header" role="gridcell">
						<div class="next_table_cell_wrapper">所在地区</div>
					</th>
					<th rowspan="1" type="header" role="gridcell">
						<div class="next_table_cell_wrapper">详细地址</div>
					</th>
					<th rowspan="1" type="header" role="gridcell">
						<div class="next_table_cell_wrapper">邮编</div>
					</th>
					<th rowspan="1" type="header" role="gridcell">
						<div class="next_table_cell_wrapper">电话/手机</div>
					</th>
					<th rowspan="1" type="header" role="gridcell">
						<div class="next_table_cell_wrapper">操作</div>
					</th>
					<th rowspan="1" type="header" role="gridcell">
						<div class="next_table_cell_wrapper"></div>
					</th>
				</tr>
			</thead>
			<tbody id="ad_body" class="next_table_body">
				

			</tbody>
		</table>
	</div>

</div>
<script src="../js/jquery-1.11.3.min.js"></script>
<script type="text/javascript" src="../js/jquery.min.js"></script>
<script type="text/javascript" src="../js/jquery.citys.js"></script>
<script type="text/javascript" src="../js/ajaxfileupload.js"></script>
<script type="text/javascript">
	window.currentName;   //当前用户名
	window.currentEmail;  //当前用户的邮箱
	window.currentPhone;  //当前用户的电话号码
	window.addrIndex;     //需要需改地址信息的编号
	window.uid;
	window.pics;  //当前用户的图片
	$(function() {
		window.uid = location.hash.replace("#","");
		console.log("person.uid=" + window.uid);
		showAddrInfo();
		showUserInfo();
	});
	
	
	
	function showUserInfo() {
		var uid = window.uid;   //uid需要从别的页面获取  来确定登录的为哪个用户
		$.post("../usr", {op:"findAllByID", uid:uid}, function(data) {
			window.currentName = data.uname;
			window.currentEmail = data.uemail;
			window.currentPhone = data.utel;
			window.pics = data.upics;
			$("#nav_img").attr("src", "../" + data.upics);
			console.log(data.upics);
			$("#usrName").val(data.uname);
			$("#p_img").attr("src", "../" + data.upics);
			$("#p_usrName").val(data.uname);
			$("#p_email").val(data.uemail);
			$("#p_phone").val(data.utel);
		},"json")
	}
	
	
	$("#imgFile").change(function() {
		//更改图像的方法
		console.log(URL.createObjectURL($(this)[0].files[0]));
		$("#p_img").attr("src",URL.createObjectURL($(this)[0].files[0]));
	})
	
	function changeImg() {
		//a标签的点击事件
		$("#imgFile").click();
	}
	
	function showAddr(index, arid) {
		$("#adBtn").val("修改");
		
		window.addrIndex = arid;
		//点击修改展示地址信息
		var name = $("#tb_addrname" + index).text();
		$("#consigneeName").val(name);
		var area = $("#tb_area" + index).text();
		var areas = area.split(" ");
		console.log(areas);
		var province = areas[0];  //省份
		var city = areas[1];  //市
		var county = areas[2];  //区/县
		$("#place").text("");
		$('#demo3').citys({valueType:'name',province:province,city:city, 
			});
		
		var address = $("#tb_address" + index).text();
		$("#area-textare").val(address);
		var postcode = $("#tb_postcode" + index).text();
		$("#p_num").val(postcode);
		var tel = $("#tb_tel" + index).text();
		$("#adPhone").val(tel);
		
	}
	
	function showAddrInfo() { 
		$("#ad_body").html("");
		$("#adBtn").val("保存");
		$("#consigneeName").val("");
		$("#area-textare").val("");
		$("#p_num").val("");
		$("#adPhone").val("");
		var uid = window.uid;   //uid需要从别的页面获取  来确定登录的为哪个用户
		$.post("../usr", {op:"findAddrsById", uid:uid}, function(data) {
			var str = "";
			var index = 0;
			var isDefault;
			$.each(data, function(index, item) {
				index = index + 1;
				isDefault = item.isdefault;
				var addr = item.province + " " + item.city + " " + item.county;
				var pCode = item.postcode;
				if (pCode == null) {
					pCode = '000000';
				}
				str +='<tr class="next_table_row" role="row">'
					+'<td><div id="tb_addrname'+index+'" class="next_table_cell_wrapper">'+item.addrname+'</div></td>'
					+'<td><div class="next_table_cell_wrapper"><span id="tb_area'+index+'">'+ addr +'</span></div></td>'
					+'<td><div id="tb_address'+index+'" class="next_table_cell_wrapper">'+item.raddress+'</div></td>'
					+'<td><div id="tb_postcode'+index+'" class="next_table_cell_wrapper">'+pCode+'</div></td>'
					+'<td><div  class="next_table_cell_wrapper"><span id="tb_tel'+index+'">'+item.addrtel+'<br /></span></div></td>'
					+'<td><div class="next_table_cell_wrapper"><div class="tAction"><a href="#" style="color: #333333;" onclick="showAddr('+index+','+item.arid+')">修改</a></div></div></td>'
					+'<td><div class="next_table_cell_wrapper"><div >';
					if (isDefault == 1) {
						str += '<span class="t_default">默认地址</span>';
					} else {
						str += '<a onclick="setAddrState('+item.arid+')">设为默认</a>';
					}
					str += '</div></div></td></tr>';
					
			});
			$("#ad_body").append($(str));
		},"json");
	}
	
	function setAddrState(arid) {
		updateAddrState(0,window.uid,"uid");
		updateAddrState(1,arid,"arid");
		showAddrInfo();
	}
	
	function checkArea() {
		$(".areaEr").attr("style", "display: none");
		//检查详细地址是否为空
		var area = $("#area-textare").val();
		if (area == "") {
			$(".areaEr").attr("style", "display: block");
		}
	}
	
	function checkAdPhone() {
		$(".adPhoneEr").attr("style", "display: none");
		var phone = $("#adPhone").val();
		var reg = /^(13[0-9]|14[5|7]|15[0|1|2|3|5|6|7|8|9]|18[0|1|2|3|5|6|7|8|9])\d{8}$/;
		if (!reg.test(phone)) {
			$(".adPhoneEr").attr("style", "display: block");
		}
	}
	
	function checkCName() {
		$(".lengthEr").attr("style", "display: none");
		//检查收货人名字长度
		var consigneeName = $("#consigneeName").val();
		
		if (consigneeName == "") {
			$(".lengthEr").attr("style", "display: block");
		}
	}
	
	function checkNum() {
		//检查邮编号
		$(".numEr").attr("style", "color: red; display: none");
		var num = $("#p_num").val();
		var reg = /[1-9]\d{5}(?!\d)/;
		if (num == "") {
			return;
		}
		if (!reg.test(num)){
			$(".numEr").attr("style", "color: red; display: block");
		}
	}
	
	function checkPhone() {
		$(".phoneEr").attr("style", "display: none");
		$(".phoneReEr").attr("style", "display: none");
		//检查电话号码格式
		var phone = $("#p_phone").val();
		if (phone == window.currentPhone) {
			return;
		}
		var reg = /^(13[0-9]|14[5|7]|15[0|1|2|3|5|6|7|8|9]|18[0|1|2|3|5|6|7|8|9])\d{8}$/;
		if (!reg.test(phone)) {
			$(".phoneEr").attr("style", "display: block");
			return;
		}
		$.post("../usr", {op:"findByUsrName", usrName:phone}, function(data) {
			if (data == null) {
				return;
			}
			$(".phoneReEr").attr("style", "display: block");
			
		},"json");
	}
	
	function checkEmail() {
		//检查邮箱格式
		$(".emailEr").attr("style", "display: none");
		$(".emailREEr").attr("style", "display: none");
		var email = $("#p_email").val();
		if (email == window.currentEmail) {
			return;
		}
		var reg = /^\w+([-+.]\w+)*@\w+([-.]\w+)*\.\w+([-.]\w+)*$/;
		if (!reg.test(email)) {
			$(".emailEr").attr("style", "display: block");
			return;
		}
		$.post("../usr", {op:"findByUsrName", usrName:email}, function(data) {
			if (data == null) {
				return;
			}
			$(".emailREEr").attr("style", "display: block");
			
		},"json");
	}
	
	function checkName() {
		$(".nullNameEr").attr("style", "display: none");
		$(".nameEr").attr("style", "display: none");
		//检查昵称是否已经被使用
		var usrName = $("#p_usrName").val();
		if (usrName == window.currentName) {
			return;
		}
		if (usrName == "") {
			$(".nullNameEr").attr("style", "display: block");
			return;
		}
		$.post("../usr", {op:"findByUsrName", usrName:usrName}, function(data) {
			if (data == null) {
				return;
			}
			$(".nameEr").attr("style", "display: block");
			
		},"json");
	}
		
	function sumbitAdr() {
		var uid = window.uid;   //uid需要从别的页面获取  来确定登录的为哪个用户
		var lengthEr = $(".lengthEr").css("display");
		var adPhoneEr = $(".adPhoneEr").css("display");
		var numEr = $(".numEr").css("display");
		var areaEr = $(".areaEr").css("display");
		
		if (lengthEr == "block" || adPhoneEr == "block" || numEr == "block" || areaEr == "block"  ) {
			alert("操作失败，消息填写有误...");
			return;
		}
		var consigneeName = $("#consigneeName").val();
		var area_textare = $("#area-textare").val();
		var p_num = $("#p_num").val();
		var adPhone = $("#adPhone").val();
		var province = $("#sl_province").find("option:selected").text();
		var city = $("#sl_city").find("option:selected").text();
		var county = $("#sl_area").find("option:selected").text();  //区/县
		if (city == "" || city == null || city.lenth <= 0) {
			city = "直辖市";
		}
		
		var isDefault = $("#isDefault").is(':checked');
		if (isDefault) {
			isDefault = 1;
			updateAddrState(0,uid,"uid");
		} else {
			isDefault = 0;
		}
		if (consigneeName == "" || area_textare == "" || adPhone == "") {
			alert("消息不能为空");
			return;
		}
		var type = $("#adBtn").val();
		if (type == "保存") {
			//新增地址信息
			$.post("../address", {op: "addAddress",province: province, city: city, county: county,raddress:area_textare,isDefault:isDefault, uid: uid,consigneeName:consigneeName, adPhone:adPhone, p_num:p_num  }, function(data) {
				if (data > 0) {
					showAddrInfo();
				} else {
					alert("保存失败...");
				}
			},"text")
		} else if (type == "修改") {
			var arid = window.addrIndex;
			//修改地址信息
			$.post("../address", {op: "updateAddress",province: province, city: city, county: county,raddress:area_textare,isDefault:isDefault, arid: arid,consigneeName:consigneeName, adPhone:adPhone, p_num:p_num  }, function(data) {
				if (data > 0) {
					
					showAddrInfo();
				} else {
					alert("修改失败...");
				}
			},"text")
		}
		
	}

	function updateAddrState(state,id, idName) {
		$.post("../address", {op:"updateAddrState", state:state, id:id, idName:idName}, function(data) {
			if (data < 0) {
				alert("修改地址状态失败,请联系管理员...");
			}
		}, "test");
	}
	
	function sumbit() {
		var uid = window.uid;   //uid需要从别的页面获取  来确定登录的为哪个用户
		
		//个人资料的提交
		var nullNameEr = $(".nullNameEr").css("display");
		var nameEr = $(".nameEr").css("display");
		var emailEr = $(".emailEr").css("display");
		var phoneEr = $(".phoneEr").css("display");
		var emailREEr = $(".emailREEr").css("display");
		var phoneReEr = $(".phoneReEr").css("display");
		if (nullNameEr == "block" || nameEr == "block" || emailEr == "block" || phoneEr == "block" || emailREEr == "block" || phoneReEr == "block" ) {
			alert("保存失败，消息填写有误...");
			return;
		}
		var p_usrName = $("#p_usrName").val();  //昵称
		var p_email = $("#p_email").val();  //邮箱
		var p_phone = $("#p_phone").val();  //电话号码
		var p_img = $("#imgFile").val();
		
		
		if (p_usrName == window.currentName && p_email == window.currentEmail && p_phone == window.currentPhone && p_img == "") {
			return;
		}
		$.ajaxFileUpload({
			url: "../usr?op=updateUsrInfo&uid=" + uid,
			secureuri: false,
			fileElementId: ["imgFile"],
			data: {p_usrName: p_usrName, p_email: p_email, p_phone: p_phone},
			dataType: "text",
			success: function(data, status) {
				data = parseInt($.trim(data));
				if (data == -1) {
					alert("您输入的信息不完整，请确认后重新输入...");
				} else if (data > 0) {
					alert("修改成功...");
					showUserInfo();
				} else {
					alert("修改失败...");
				}
			},
			error: function(data, status, e) {
				alert("修改失败...\n" + e);
			}
		})
	}

	function person() {  //进入个人资料页面
		$("#address").attr("style", "display: none");
		$("#person").attr("style", "display: block");
		showUserInfo();
	}

	function address() { //进入收货地址主页
		showAddrInfo();
		$("#person").attr("style", "display: none");
		$("#address").attr("style", "display: block");
	}

	$('#demo3').citys({
        required:false,
        nodata:'disabled',
        onChange:function(data){
            var text = data['direct']?'(直辖市)':'';
            $('#place').text('当前选中地区：'+data['province']+text+' '+data['city']+' '+data['area']);
        }
    });
	
</script>
